<!DOCTYPE html>

<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>Grafos de Iniciativas</title>
  <style>
    /*@import url(../style.css);*/

    .node {
      stroke: #fff;
      stroke-width: 1.5px;
    }

    .link {
      stroke: #999;
      stroke-opacity: .8;
    }

    body {
      background: #dddddd;
    }

    #page {
      fill: #fff;
      stroke: #bbb;
      stroke-width: 1px;
    }

    #loading {
      position: absolute;
      top: 40%;
      left: 50%;
      z-index: 1;
    }

    #svgContainer {
      position: absolute;
      z-index: 2;
    }
  </style>
</head>

<body>
  <script src="./js/d3.v3.js"></script>
  <script src="./js/cola.js"></script>
  <script>
    var width = window.visualViewport.width - 20,
      height = window.visualViewport.height - 100;

    var color = d3.scale.category20();

    var cola = cola.d3adaptor()
      .size([width, height]);

    var svg = d3.select("body").append("svg")
      .attr("id", "svgContainer")
      .attr("width", width)
      .attr("height", height);

    let dataSetJson = "./data/teams.json";
    var filter = getParameterByName("filter");
    //let dataSetJson = 'https://script.google.com/macros/s/AKfycbyoOE7lYVrSgj2-9hzzrE939bJQRNqxjHrlropmGDcCrcHnu9rd/exec';

    if (filter.length > 0) {
      dataSetJson += "?filter=" + filter
    }

    d3.json(dataSetJson, function (error, graph) {
      var pageBounds = { x: 0, y: 0, width: width, height: height };
      var page = svg.append('rect').attr('id', 'page').attr(pageBounds);
      var realGraphNodes = graph.nodes.slice(0);
      console.log(graph);

      var fixedNode = { fixed: true, fixedWeight: 100 };
      var topLeft = { ...fixedNode, x: pageBounds.x, y: pageBounds.y };
      var tlIndex = graph.nodes.push(topLeft) - 1;
      var bottomRight = { ...fixedNode, x: pageBounds.x + pageBounds.width, y: pageBounds.y + pageBounds.height };
      var brIndex = graph.nodes.push(bottomRight) - 1;
      var constraints = [];
      /*for (var i = 0; i < realGraphNodes.length; i++) {
        let nodeRadius = realGraphNodes[i].r;
        constraints.push({ axis: 'x', type: 'separation', left: tlIndex, right: i, gap: nodeRadius });
        constraints.push({ axis: 'y', type: 'separation', left: tlIndex, right: i, gap: nodeRadius });
        constraints.push({ axis: 'x', type: 'separation', left: i, right: brIndex, gap: nodeRadius });
        constraints.push({ axis: 'y', type: 'separation', left: i, right: brIndex, gap: nodeRadius });
      }*/
      /*for (var i = 0; i < realGraphNodes.length; i++) {
        let radius = realGraphNodes[i].r;
      }*/

      cola
        .nodes(graph.nodes)
        .links(graph.links)
        /*.jaccardLinkLengths(40, 0.2)*/
        /*.symmetricDiffLinkLengths(30)*/
        .constraints(constraints)
        .linkDistance(60)
        /*.handleDisconnected(true)*/
        .start(30);

      var link = svg.selectAll(".link")
        .data(graph.links)
        .enter().append("line")
        .attr("class", "link")
        .style("stroke-width", function (d) { return Math.sqrt(d.value); });

      var node = svg.selectAll(".node")
        .data(realGraphNodes)
        .enter().append("circle")
        .attr("class", "node")
        .attr("r", function (d) { return d.radius; })
        .attr("cx", 200)
        .style("fill", function (d) { return color(d.group); })
        .call(cola.drag)
        .on("mouseover", overCircle)
        .on("mouseout", outCircle);

      node.append("title")
        .text(function (d) { return d.name; });

      var label = svg.selectAll(".label")
        .data(realGraphNodes)
        .enter().append("text")
        .attr("class", "label")
        .text(function (d) { return d.name; })
        /*.style("fill", "#F00")*/
        .style("fill", function (d) { return color(d.group); })
        .call(cola.drag);

      cola.on("tick", function () {
        console.log("tick");

        node.attr("cx", function (d) { return d.x })
          .attr("cy", function (d) { return d.y })


        link.attr("x1", function (d) { return d.source.x; })
          .attr("y1", function (d) { return d.source.y; })
          .attr("x2", function (d) { return d.target.x; })
          .attr("y2", function (d) { return d.target.y; });


        label.attr("x", function (d) {
          let nameLeng = d.name.length;
          return d.x - (nameLeng * 3);
        })
          .attr("y", function (d) {
            var h = this.getBBox().height;
            return (d.y + h / 4) + 25;
          })


        page.attr(pageBounds = {
          x: topLeft.x,
          y: topLeft.y,
          width: bottomRight.x - topLeft.x,
          height: bottomRight.y - topLeft.y
        });
      });
    });

    var elem = document.documentElement;
    function openFullscreen() {
      if (elem.requestFullscreen) {
        elem.requestFullscreen();
      } else if (elem.mozRequestFullScreen) { /* Firefox */
        elem.mozRequestFullScreen();
      } else if (elem.webkitRequestFullscreen) { /* Chrome, Safari & Opera */
        elem.webkitRequestFullscreen();
      } else if (elem.msRequestFullscreen) { /* IE/Edge */
        elem.msRequestFullscreen();
      }
    }

    /**
   * @param String name
   * @return String
   */
    function getParameterByName(name) {
      name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
      var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
        results = regex.exec(location.search);
      return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
    }

    function overCircle() {
      console.log("over", this);
    }
    function outCircle() {
      console.log("out", this);
    }

    /*
      https://medium.com/dailyjs/how-to-remove-array-duplicates-in-es6-5daa8789641c
      [...new Set(filter)]

    var filter = ["item1", "item2", "item1", "item2", "item2"]
    var finalFiter = [...new Set(filter)];
    */

    /*
    var ini = [
      {
        "id": 4,
        "name": "Frontend en Kubernates",
        "radius": 20,
        "dimentions": [
          "tag2",
          "tag3"
        ],
        "group": 1
      },
      {
        "id": 0,
        "name": "Estrategias para crear api de legacy de manera sana",
        "dimentions": [
          "tag1",
          "tag2",
          "tag3"
        ],
        "group": 1,
        "radius": 20
      },
      {
        "id": 1,
        "name": "Estrategias para crear api de legacy de manera sana",
        "dimentions": [
          "tag1",
          "tag2",
          "tag3"
        ],
        "group": 1,
        "radius": 20
      },
      {
        "id": 20,
        "name": "Estandar y conveción de nombres para los css",
        "dimentions": [
          "tag1",
          "tag2"
        ],
        "group": 1,
        "radius": 20
      },
      {
        "id": 3,
        "name": "Estandar y conveción de nombres para los css",
        "radius": 20,
        "dimentions": [
          "tag1",
          "tag2"
        ],
        "group": 1
      }
    ]

    function compare(a, b) {
      // Use toUpperCase() to ignore character casing
      const aObj = a.name.toUpperCase();
      const bObj = b.name.toUpperCase();

      let comparison = 0;
      if (aObj > bObj) {
        comparison = 1;
      } else if (aObj < bObj) {
        comparison = -1;
      }
      return comparison
    }

    function compareValues(key, order = 'asc') {
      return function innerSort(a, b) {
        if (!a.hasOwnProperty(key) || !b.hasOwnProperty(key)) {
          // property doesn't exist on either object
          return 0;
        }

        const varA = (typeof a[key] === 'string')
          ? a[key].toUpperCase() : a[key];
        const varB = (typeof b[key] === 'string')
          ? b[key].toUpperCase() : b[key];

        let comparison = 0;
        if (varA > varB) {
          comparison = 1;
        } else if (varA < varB) {
          comparison = -1;
        }
        return (
          (order === 'desc') ? (comparison * -1) : comparison
        );
      };
    }

    function filterMachine(cur, ind, arr, args) {
      if ((ind + 1) < arr.length) {
        if (arr[ind].name != arr[ind + 1].name) {
          return true
        }
      } else {
        return true
      }
    }

    function replaceIndexes(lastIndex = 0) {
      return function innerReplaceIndexes(currentValue, index) {
        currentValue.id = index + lastIndex
        return true
      }
    }
    var res = ini.sort(compareValues("name")).filter(filterMachine).filter(replaceIndexes(7));
    console.log(res)
    /**/


  </script>
  <button onclick="openFullscreen();">Open Fullscreen</button>
  <a href="https://ialab.it.monash.edu/webcola/examples/pageBoundsConstraints.html" target="_blank">extraido de aquí</a>
  <div id="loading">Loading...</div>
</body>

</html>