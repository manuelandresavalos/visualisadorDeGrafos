<!DOCTYPE html>

<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>Grafos de Iniciativas</title>
  <style>
    /*@import url(../style.css);*/

    .node {
      stroke: #fff;
      stroke-width: 3px;
    }

    .link {
      stroke: #999;
      stroke-opacity: .8;
    }

    body {
      background: #dddddd;
    }

    #page {
      fill: #262626;
      stroke: #bbb;
      stroke-width: 1px;
    }

    #loading {
      position: absolute;
      top: 40%;
      left: 50%;
      z-index: 1;
    }

    #svgContainer {
      position: absolute;
      z-index: 2;
    }

    #detalles {
      display: none;
      position: absolute;
      top: 20px;
      bottom: 30px;
      right: 30px;
      width: 380px;
      border: 1px solid #ccc;
      padding: 20px;
      background-color: #fff;
      z-index: 3;
    }

    #detalles h2 {
      margin-top: 0px;
    }

    /*
        circle[Attributes Style] {
        cx: 150;
        cy: 150;
        r: 60;
        fill: rgb(0, 174, 239);
        stroke: rgb(255, 255, 255);
        filter: url(#Sk9ym14buf);
    }
    */
  </style>
</head>

<body>
  <script type="text/javascript" src="./js/Snap.svg-0.4.1/dist/snap.svg-min.js"></script>
  <script src="./js/d3.v3.js"></script>
  <script src="./js/cola.js"></script>
  <script>
    var width = window.visualViewport.width - 20,
      height = window.visualViewport.height - 20;

    var color = d3.scale.category20();

    var cola = cola.d3adaptor()
      .size([width, height]);

    var svg = d3.select("body").append("svg")
      .attr("id", "svgContainer")
      .attr("width", width)
      .attr("height", height);

    let dataSetJson = "./data/teams.json";
    var filter = getParameterByName("filter");
    //let dataSetJson = 'https://script.google.com/macros/s/AKfycbyoOE7lYVrSgj2-9hzzrE939bJQRNqxjHrlropmGDcCrcHnu9rd/exec';

    if (filter.length > 0) {
      dataSetJson += "?filter=" + filter
    }

    d3.json(dataSetJson, function (error, graph) {
      var pageBounds = { x: 0, y: 0, width: width, height: height };
      var page = svg.append('rect').attr('id', 'page').attr(pageBounds);
      var realGraphNodes = graph.nodes.slice(0);
      console.log(graph);

      var fixedNode = { fixed: true, fixedWeight: 100 };
      var topLeft = { ...fixedNode, x: pageBounds.x, y: pageBounds.y };
      var tlIndex = graph.nodes.push(topLeft) - 1;
      var bottomRight = { ...fixedNode, x: pageBounds.x + pageBounds.width, y: pageBounds.y + pageBounds.height };
      var brIndex = graph.nodes.push(bottomRight) - 1;
      var constraints = [];

      cola
        .nodes(graph.nodes)
        .links(graph.links)
        /*.jaccardLinkLengths(40, 0.2)*/
        /*.symmetricDiffLinkLengths(30)*/
        .linkDistance(80)
        /*.handleDisconnected(true)*/
        .start(30);

      var link = svg.selectAll(".link")
        .data(graph.links)
        .enter().append("line")
        .attr("class", "link")
        .style("stroke-width", function (d) { return Math.sqrt(d.value); });

      var node = svg.selectAll(".node")
        .data(realGraphNodes)
        .enter().append("circle")
        .attr("class", "node")
        .attr("r", function (d) { return d.radius; })
        .attr("cx", 200)
        .attr("style", "filter=url('#dropshadow')")
        .style("fill", function (d) { return color(d.group); })
        .call(cola.drag)
        /*.on("mouseover", overCircle)
        .on("mouseout", outCircle)
        */
        .on("click", clickCircle)

      var label = svg.selectAll(".label")
        .data(realGraphNodes)
        .enter().append("text")
        .attr("class", "label")
        /*.text(function (d) { return d.name; })*/
        /*.style("fill", "#F00")*/
        .style("fill", function (d) { return color(d.group); })
        .call(cola.drag);

      cola.on("tick", function () {
        node.attr("cx", function (d) { return d.x })
          .attr("cy", function (d) { return d.y })


        link.attr("x1", function (d) { return d.source.x; })
          .attr("y1", function (d) { return d.source.y; })
          .attr("x2", function (d) { return d.target.x; })
          .attr("y2", function (d) { return d.target.y; });


        label.attr("x", function (d) {
          let nameLeng = d.name.length;
          return d.x - (nameLeng * 3);
        })
          .attr("y", function (d) {
            var h = this.getBBox().height;
            return (d.y + h / 4) + 25;
          })


        page.attr(pageBounds = {
          x: topLeft.x,
          y: topLeft.y,
          width: bottomRight.x - topLeft.x,
          height: bottomRight.y - topLeft.y
        });
      });
    });

    var elem = document.documentElement;
    function openFullscreen() {
      if (elem.requestFullscreen) {
        elem.requestFullscreen();
      } else if (elem.mozRequestFullScreen) { /* Firefox */
        elem.mozRequestFullScreen();
      } else if (elem.webkitRequestFullscreen) { /* Chrome, Safari & Opera */
        elem.webkitRequestFullscreen();
      } else if (elem.msRequestFullscreen) { /* IE/Edge */
        elem.msRequestFullscreen();
      }
    }

    /**
   * @param String name
   * @return String
   */
    function getParameterByName(name) {
      name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
      var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
        results = regex.exec(location.search);
      return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
    }

    function overCircle() {
      console.log("over", this);
    }
    function outCircle() {
      console.log("out", this);
    }
    function clickCircle(d) {
      if (d.group != 1) {
        var detalles = document.getElementById("detalles");
        show(detalles)
      }
    }

    // Show an element
    var show = function (elem) {
      elem.style.display = 'block';
    };

    // Hide an element
    var hide = function (elem) {
      elem.style.display = 'none';
    };

    document.body.addEventListener("click", function (event) {
      if (event.target.id == "page") {
        var detalles = document.getElementById("detalles");
        hide(detalles)
      }
    }, false)
  </script>
  <button onclick="openFullscreen();">Open Fullscreen</button>
  <a href="https://ialab.it.monash.edu/webcola/examples/pageBoundsConstraints.html" target="_blank">extraido de aqu√≠</a>

  <div id="loading">Loading...</div>

  <div id="detalles">
    <h2 class="title">Caja de compras</h2>
    <div class="equipo">
      <div class="titleTeam">Equipo 1</div>
      <ul>
        <li>JIRA-123 - Titulo del ticket 1 - [in-progress]</li>
        <li>JIRA-229 - Titulo del ticket 2 - [in-progress]</li>
        <li>JIRA-426 - Titulo del ticket 3 - [in-progress]</li>
        <li>JIRA-134 - Titulo del ticket 4 - [pending]</li>
        <li>JIRA-223 - Titulo del ticket 5 - [in-design]</li>
      </ul>
    </div>
    <div class="equipo">
      <div class="titleTeam">Equipo 2</div>
      <ul>
        <li>JIRA-134 - Titulo del ticket 4 - [pending]</li>
        <li>JIRA-223 - Titulo del ticket 5 - [in-design]</li>
      </ul>
    </div>
  </div>
</body>

</html>